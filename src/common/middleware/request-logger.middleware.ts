/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘                    RAFIQ PLATFORM - Request Logger Middleware                  â•‘
 * â•‘                                                                                â•‘
 * â•‘  ğŸ“Œ Middleware Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø·Ù„Ø¨ HTTP ÙŠØµÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚                                  â•‘
 * â•‘                                                                                â•‘
 * â•‘  ğŸ¤” Ù…Ø§ Ù‡Ùˆ MiddlewareØŸ                                                          â•‘
 * â•‘     ÙƒÙˆØ¯ ÙŠÙÙ†ÙØ° Ù‚Ø¨Ù„ ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù€ Controller                                    â•‘
 * â•‘     ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨/Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø£Ùˆ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨                                   â•‘
 * â•‘                                                                                â•‘
 * â•‘  ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†ÙÙŠØ°:                                                                â•‘
 * â•‘     Request â†’ Middleware â†’ Guards â†’ Interceptors â†’ Pipes â†’ Controller         â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

import { Injectable, NestMiddleware, Logger } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { v4 as uuidv4 } from 'uuid';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Request Logger Middleware
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/**
 * ğŸ“ RequestLoggerMiddleware
 *
 * ÙŠØ³Ø¬Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† ÙƒÙ„ Ø·Ù„Ø¨ HTTP:
 * - Request ID ÙØ±ÙŠØ¯ Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
 * - HTTP Method (GET, POST, etc.)
 * - URL Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
 * - Ø¹Ù†ÙˆØ§Ù† IP Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 * - ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
 * - Status Code
 *
 * @Injectable() - ÙŠØ³Ù…Ø­ Ù„Ù€ NestJS Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ lifecycle
 */
@Injectable()
export class RequestLoggerMiddleware implements NestMiddleware {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Logger Instance
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /**
   * Logger Ù…Ù† NestJS:
   * - ÙŠØ¶ÙŠÙ timestamp ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
   * - ÙŠØ¯Ø¹Ù… Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù€ console
   * - ÙŠÙ…ÙƒÙ† ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø®Ø¯Ù…Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©
   *
   * 'HTTP' = Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ (Context)
   * ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù€ log: [HTTP] GET /api/users...
   */
  private readonly logger = new Logger('HTTP');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // use() - Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù€ Middleware
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /**
   * @param request - ÙƒØ§Ø¦Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Express
   * @param response - ÙƒØ§Ø¦Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Express
   * @param next - Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù€ middleware Ø§Ù„ØªØ§Ù„ÙŠ
   *
   * ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ next() Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
   * Ø¥Ø°Ø§ Ù„Ù… ØªØ³ØªØ¯Ø¹Ù next(): Ø§Ù„Ø·Ù„Ø¨ ÙŠØªÙˆÙ‚Ù Ù‡Ù†Ø§ (Ù…ÙÙŠØ¯ Ù„Ù„Ù€ Auth)
   */
  use(request: Request, response: Response, next: NextFunction): void {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1ï¸âƒ£ ØªÙˆÙ„ÙŠØ¯ Request ID
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /**
     * ğŸ”‘ Request ID - Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø·Ù„Ø¨
     *
     * Ø§Ù„ÙÙˆØ§Ø¦Ø¯:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * 1. ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ù€ logs
     * 2. Ø±Ø¨Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø¨Ø¨
     * 3. debugging ÙÙŠ Ø§Ù„Ù€ Production
     * 4. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
     *
     * Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:
     * 1. X-Request-ID Ù…Ù† Ø§Ù„Ù€ headers (Ù…Ù† Load Balancer Ø£Ùˆ API Gateway)
     * 2. ØªÙˆÙ„ÙŠØ¯ UUID Ø¬Ø¯ÙŠØ¯
     *
     * Ù…Ø«Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ÙÙŠ Ø§Ù„Ù€ Service:
     * const requestId = request.headers['x-request-id'];
     * this.logger.error(`[${requestId}] Failed to process...`);
     */
    const requestId =
      (request.headers['x-request-id'] as string) || uuidv4();

    // Ø¥Ø¶Ø§ÙØ© Request ID Ù„Ù„Ù€ headers (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹)
    request.headers['x-request-id'] = requestId;

    // Ø¥Ø±Ø³Ø§Ù„ Request ID ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ù…ÙÙŠØ¯ Ù„Ù„Ù€ debugging)
    response.setHeader('X-Request-ID', requestId);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2ï¸âƒ£ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /**
     * method: GET, POST, PUT, PATCH, DELETE
     * originalUrl: Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ query string
     * ip: Ø¹Ù†ÙˆØ§Ù† IP Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    const { method, originalUrl } = request;

    /**
     * ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ IP Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
     *
     * ÙÙŠ Production Ø®Ù„Ù Load Balancer:
     * - request.ip Ù‚Ø¯ ÙŠÙƒÙˆÙ† IP Ø§Ù„Ù€ Load Balancer
     * - X-Forwarded-For ÙŠØ­ØªÙˆÙŠ IP Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
     *
     * X-Forwarded-For format:
     * "client, proxy1, proxy2"
     * Ù†Ø£Ø®Ø° Ø§Ù„Ø£ÙˆÙ„ (client)
     *
     * X-Real-IP: Ø¨Ø¹Ø¶ Ø§Ù„Ù€ proxies ØªØ³ØªØ®Ø¯Ù…Ù‡
     */
    const clientIp = this.getClientIp(request);

    /**
     * ğŸ“± User Agent - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ø¬Ù‡Ø§Ø²
     *
     * Ù…Ø«Ø§Ù„:
     * "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0) AppleWebKit/605.1.15"
     *
     * Ù…ÙÙŠØ¯ Ù„Ù€:
     * - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
     * - Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙˆØªØ§Øª
     * - ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø±Ø¨Ø©
     */
    // const _userAgent = request.headers['user-agent'] || 'unknown';

    /**
     * ğŸ‘¤ Tenant ID - Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Multi-tenant
     *
     * ÙŠÙØ±Ø³Ù„ ÙÙŠ header Ù…Ø®ØµØµ Ù…Ù† Ø§Ù„Ù€ Frontend
     * ÙŠÙØ³ØªØ®Ø¯Ù… Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
     */
    const tenantId = request.headers['x-tenant-id'] as string;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø·Ù„Ø¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /**
     * â±ï¸ Ù‚ÙŠØ§Ø³ ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
     *
     * Date.now() = Ø¹Ø¯Ø¯ Ø§Ù„Ù€ milliseconds Ù…Ù†Ø° 1970
     * Ù†Ø·Ø±Ø­ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
     */
    const startTime = Date.now();

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙˆØ§Ø±Ø¯
    this.logger.log(
      `â†’ ${method} ${originalUrl} | ` +
        `IP: ${clientIp} | ` +
        `ReqID: ${requestId.substring(0, 8)}...` +
        (tenantId ? ` | Tenant: ${tenantId}` : ''),
    );

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø·Ù„Ø¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /**
     * ğŸ”„ Event Listener Ø¹Ù„Ù‰ 'finish'
     *
     * response.on('finish', callback):
     * ÙŠÙÙ†ÙØ° Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
     *
     * Ù„Ù…Ø§Ø°Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ØŸ
     * - Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ status code Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
     * - Ù‚ÙŠØ§Ø³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
     * - ØªØ³Ø¬ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
     *
     * Ø¨Ø¯Ø§Ø¦Ù„:
     * - 'close': Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„
     * - 'error': Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
     */
    response.on('finish', () => {
      const { statusCode } = response;
      const duration = Date.now() - startTime;

      /**
       * ğŸ“Š Content-Length - Ø­Ø¬Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ù€ bytes
       *
       * Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¥Ø°Ø§:
       * - Chunked transfer encoding
       * - Streaming response
       */
      const contentLength = response.get('content-length') || '0';

      /**
       * ğŸ¨ ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Status Code
       *
       * 2xx: Ù†Ø¬Ø§Ø­ (Ø£Ø®Ø¶Ø±)
       * 3xx: Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ (Ø£Ø²Ø±Ù‚)
       * 4xx: Ø®Ø·Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ØµÙØ±)
       * 5xx: Ø®Ø·Ø£ Ø§Ù„Ø®Ø§Ø¯Ù… (Ø£Ø­Ù…Ø±)
       */
      const logMethod = this.getLogMethod(statusCode);
      const statusEmoji = this.getStatusEmoji(statusCode);

      // ØªØ³Ø¬ÙŠÙ„ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
      this.logger[logMethod](
        `${statusEmoji} ${method} ${originalUrl} | ` +
          `${statusCode} | ` +
          `${duration}ms | ` +
          `${this.formatBytes(parseInt(contentLength))} | ` +
          `ReqID: ${requestId.substring(0, 8)}...`,
      );

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // 5ï¸âƒ£ ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      /**
       * âš ï¸ Slow Request Warning
       *
       * Ø¥Ø°Ø§ Ø§Ø³ØªØºØ±Ù‚ Ø§Ù„Ø·Ù„Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø«ÙˆØ§Ù†ÙŠ:
       * - ØªØ³Ø¬ÙŠÙ„ ØªØ­Ø°ÙŠØ±
       * - Ù…ÙÙŠØ¯ Ù„Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
       *
       * Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:
       * - API endpoints: 3 Ø«ÙˆØ§Ù†ÙŠ
       * - File uploads: 30 Ø«Ø§Ù†ÙŠØ©
       * - Reports: 10 Ø«ÙˆØ§Ù†ÙŠ
       */
      if (duration > 3000) {
        this.logger.warn(
          `ğŸŒ Slow request detected: ${method} ${originalUrl} took ${duration}ms | ` +
            `ReqID: ${requestId}`,
        );
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6ï¸âƒ£ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù€ Middleware Ø§Ù„ØªØ§Ù„ÙŠ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    /**
     * âš¡ next() - Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹!
     *
     * Ø¨Ø¯ÙˆÙ†Ù‡: Ø§Ù„Ø·Ù„Ø¨ ÙŠØªÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ„Ø§ ÙŠØµÙ„ Ù„Ù„Ù€ Controller
     * Ù…Ø¹Ù‡: Ø§Ù„Ø·Ù„Ø¨ ÙŠØªØ§Ø¨Ø¹ Ù„Ù„Ù€ middleware/guard/controller Ø§Ù„ØªØ§Ù„ÙŠ
     *
     * ÙŠÙ…ÙƒÙ† Ø¹Ø¯Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ù‡ ÙÙŠ Ø­Ø§Ù„Ø§Øª:
     * - Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ (Auth failed)
     * - Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
     */
    next();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Helper Methods
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ IP Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
   *
   * ÙŠØ£Ø®Ø° Ø¨Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø±:
   * 1. X-Forwarded-For (standard)
   * 2. X-Real-IP (Nginx)
   * 3. CF-Connecting-IP (Cloudflare)
   * 4. request.ip (fallback)
   */
  private getClientIp(request: Request): string {
    // Cloudflare
    const cfIp = request.headers['cf-connecting-ip'] as string;
    if (cfIp) return cfIp;

    // Standard proxy header
    const forwardedFor = request.headers['x-forwarded-for'];
    if (forwardedFor) {
      // Ù‚Ø¯ ÙŠÙƒÙˆÙ† string Ø£Ùˆ array
      const ips = Array.isArray(forwardedFor)
        ? forwardedFor[0]
        : forwardedFor.split(',')[0];
      return ips.trim();
    }

    // Nginx proxy header
    const realIp = request.headers['x-real-ip'] as string;
    if (realIp) return realIp;

    // Direct connection
    return request.ip || request.socket.remoteAddress || 'unknown';
  }

  /**
   * ğŸ“Š Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù€ Log Ø­Ø³Ø¨ Status Code
   */
  private getLogMethod(statusCode: number): 'log' | 'warn' | 'error' {
    if (statusCode >= 500) return 'error'; // Server errors
    if (statusCode >= 400) return 'warn'; // Client errors
    return 'log'; // Success & redirects
  }

  /**
   * ğŸ¨ Emoji Ø­Ø³Ø¨ Status Code
   */
  private getStatusEmoji(statusCode: number): string {
    if (statusCode >= 500) return 'âŒ'; // Server error
    if (statusCode >= 400) return 'âš ï¸'; // Client error
    if (statusCode >= 300) return 'â†ªï¸'; // Redirect
    if (statusCode >= 200) return 'âœ…'; // Success
    return 'ğŸ”µ'; // Informational
  }

  /**
   * ğŸ“ ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
   *
   * bytes â†’ KB, MB, GB
   */
  private formatBytes(bytes: number): string {
    if (bytes === 0) return '0 B';

    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/**
 * ğŸ“š ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ Middleware ÙÙŠ AppModule
 *
 * import { MiddlewareConsumer, NestModule } from '@nestjs/common';
 * import { RequestLoggerMiddleware } from '@common/middleware/request-logger.middleware';
 *
 * @Module({ ... })
 * export class AppModule implements NestModule {
 *   configure(consumer: MiddlewareConsumer) {
 *     consumer
 *       .apply(RequestLoggerMiddleware)
 *       .forRoutes('*'); // Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
 *
 *     // Ø£Ùˆ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­Ø¯Ø¯Ø©:
 *     // .forRoutes('users', 'auth')
 *
 *     // Ø£Ùˆ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù…Ø³Ø§Ø±Ø§Øª:
 *     // .exclude('health')
 *     // .forRoutes('*')
 *   }
 * }
 *
 * Ù…Ø«Ø§Ù„ Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠ Console:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * [HTTP] â†’ GET /api/users | IP: 192.168.1.1 | ReqID: a1b2c3d4...
 * [HTTP] âœ… GET /api/users | 200 | 45ms | 2.5 KB | ReqID: a1b2c3d4...
 *
 * [HTTP] â†’ POST /api/auth/login | IP: 192.168.1.1 | ReqID: e5f6g7h8...
 * [HTTP] âš ï¸ POST /api/auth/login | 401 | 12ms | 156 B | ReqID: e5f6g7h8...
 *
 * [HTTP] â†’ GET /api/reports/sales | IP: 192.168.1.1 | ReqID: i9j0k1l2...
 * [HTTP] ğŸŒ Slow request detected: GET /api/reports/sales took 5234ms
 * [HTTP] âœ… GET /api/reports/sales | 200 | 5234ms | 1.2 MB | ReqID: i9j0k1l2...
 */

/**
 * ╔═══════════════════════════════════════════════════════════════════════════════╗
 * ║              RAFIQ PLATFORM - AI Module                                        ║
 * ║                                                                                ║
 * ║  📌 الذكاء الاصطناعي - الرد الآلي على العملاء                                   ║
 * ║                                                                                ║
 * ║  الميزات:                                                                      ║
 * ║  - الرد التلقائي على الاستفسارات الشائعة                                       ║
 * ║  - فهم السياق والنية من الرسائل                                               ║
 * ║  - التكامل مع بيانات سلة (الطلبات، المنتجات)                                   ║
 * ║  - التحويل للموظف عند الحاجة                                                  ║
 * ╚═══════════════════════════════════════════════════════════════════════════════╝
 */

import { Module } from '@nestjs/common';
import { HttpModule } from '@nestjs/axios';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { BullModule } from '@nestjs/bullmq';
import { TypeOrmModule } from '@nestjs/typeorm';

import { Message, Conversation, Customer, Order, Tenant } from '@database/entities';
import { AIService } from './ai.service';
import { AiController } from './ai.controller';

/**
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 AI Architecture:
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * ┌─────────────────────────────────────────────────────────────────────────────┐
 * │                           AI CONVERSATION FLOW                              │
 * ├─────────────────────────────────────────────────────────────────────────────┤
 * │                                                                             │
 * │  ┌──────────────┐                                                          │
 * │  │ رسالة واردة  │                                                          │
 * │  │ من العميل    │                                                          │
 * │  └──────┬───────┘                                                          │
 * │         │                                                                   │
 * │         ▼                                                                   │
 * │  ┌──────────────────────────────────────────────────────────────────────┐  │
 * │  │                    1. Intent Classification                          │  │
 * │  │                    ────────────────────────                          │  │
 * │  │    تحديد نية العميل: استفسار عن طلب؟ منتج؟ شكوى؟ عام؟               │  │
 * │  └──────────────────────────────────────────────────────────────────────┘  │
 * │         │                                                                   │
 * │         ▼                                                                   │
 * │  ┌──────────────────────────────────────────────────────────────────────┐  │
 * │  │                    2. Context Gathering                              │  │
 * │  │                    ───────────────────                               │  │
 * │  │    جمع المعلومات المطلوبة:                                           │  │
 * │  │    - سجل المحادثة السابقة                                            │  │
 * │  │    - بيانات العميل من سلة                                            │  │
 * │  │    - الطلبات الأخيرة                                                 │  │
 * │  │    - المنتجات ذات الصلة                                              │  │
 * │  └──────────────────────────────────────────────────────────────────────┘  │
 * │         │                                                                   │
 * │         ▼                                                                   │
 * │  ┌──────────────────────────────────────────────────────────────────────┐  │
 * │  │                    3. Response Generation                            │  │
 * │  │                    ─────────────────────                             │  │
 * │  │    إنشاء الرد باستخدام OpenAI GPT-4:                                 │  │
 * │  │    - System Prompt مخصص للمتجر                                       │  │
 * │  │    - السياق المجمّع                                                  │  │
 * │  │    - النبرة المناسبة (ودية، رسمية)                                   │  │
 * │  └──────────────────────────────────────────────────────────────────────┘  │
 * │         │                                                                   │
 * │         ▼                                                                   │
 * │  ┌──────────────────────────────────────────────────────────────────────┐  │
 * │  │                    4. Action Decision                                │  │
 * │  │                    ────────────────────                              │  │
 * │  │    ├─ رد مباشر → إرسال الرد للعميل                                   │  │
 * │  │    ├─ طلب معلومات → سؤال العميل للتوضيح                              │  │
 * │  │    ├─ تصعيد → تحويل لموظف بشري                                       │  │
 * │  │    └─ إجراء → تنفيذ أمر (مثل: إلغاء طلب)                             │  │
 * │  └──────────────────────────────────────────────────────────────────────┘  │
 * │                                                                             │
 * └─────────────────────────────────────────────────────────────────────────────┘
 */

@Module({
  imports: [
    // ═══════════════════════════════════════════════════════════════════════════════
    // 📁 Database
    // ═══════════════════════════════════════════════════════════════════════════════
    TypeOrmModule.forFeature([
      Message,
      Conversation,
      Customer,
      Order,
      Tenant,
    ]),

    // ═══════════════════════════════════════════════════════════════════════════════
    // 🌐 HTTP for OpenAI API
    // ═══════════════════════════════════════════════════════════════════════════════
    HttpModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (configService: ConfigService) => ({
        baseURL: 'https://api.openai.com/v1',
        timeout: 60000, // 60 ثانية (الـ AI قد يأخذ وقت)
        headers: {
          'Authorization': `Bearer ${configService.get('ai.openaiApiKey')}`,
          'Content-Type': 'application/json',
        },
      }),
    }),

    // ═══════════════════════════════════════════════════════════════════════════════
    // 📬 Queue للمعالجة غير المتزامنة
    // ═══════════════════════════════════════════════════════════════════════════════
    BullModule.registerQueue({
      name: 'ai-processing',
      defaultJobOptions: {
        attempts: 2,
        backoff: {
          type: 'exponential',
          delay: 3000,
        },
        removeOnComplete: {
          age: 3600, // ساعة
          count: 100,
        },
      },
    }),

    ConfigModule,
  ],

  controllers: [AiController],
  
  providers: [AIService],

  exports: [AIService],
})
export class AiModule {}

/**
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 AI Capabilities:
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * 1. 📦 Order Inquiries (استفسارات الطلبات)
 *    - "أين طلبي؟" → جلب حالة الطلب من سلة
 *    - "متى يصل؟" → معلومات الشحن والتتبع
 *    - "أريد إلغاء طلبي" → شرح سياسة الإلغاء
 * 
 * 2. 🛍️ Product Questions (أسئلة المنتجات)
 *    - "هل المنتج X متوفر؟" → التحقق من المخزون
 *    - "ما سعر Y؟" → جلب السعر والعروض
 *    - "ما الفرق بين A و B؟" → مقارنة المنتجات
 * 
 * 3. 💰 Payment & Shipping (الدفع والشحن)
 *    - "ما طرق الدفع؟"
 *    - "كم رسوم الشحن؟"
 *    - "هل توصلون لمنطقتي؟"
 * 
 * 4. 🔄 Returns & Refunds (الإرجاع والاستبدال)
 *    - "أريد إرجاع المنتج"
 *    - "كيف أستبدل المقاس؟"
 *    - "متى يرجع المبلغ؟"
 * 
 * 5. 📞 Escalation (التحويل للموظف)
 *    - شكاوى جدية
 *    - طلبات معقدة
 *    - عندما يطلب العميل "أريد التحدث مع موظف"
 * 
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 Handoff Triggers (متى نحوّل للموظف):
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * 1. العميل يطلب ذلك صراحةً
 * 2. 3 رسائل متتالية لم يفهمها الـ AI
 * 3. شكوى أو غضب واضح
 * 4. موضوع حساس (مالي، قانوني)
 * 5. طلب خارج نطاق الـ AI
 */

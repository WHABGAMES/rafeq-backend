/**
 * ╔═══════════════════════════════════════════════════════════════════════════════╗
 * ║              RAFIQ PLATFORM - Campaigns Module                                 ║
 * ║                                                                                ║
 * ║  📌 إدارة الحملات التسويقية الآلية                                              ║
 * ║                                                                                ║
 * ║  الميزات:                                                                      ║
 * ║  - حملات رسائل مجدولة                                                         ║
 * ║  - حملات مشروطة (Triggered)                                                   ║
 * ║  - Segmentation العملاء                                                       ║
 * ║  - قوالب الرسائل                                                              ║
 * ║  - تحليلات الحملات                                                            ║
 * ╚═══════════════════════════════════════════════════════════════════════════════╝
 */

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { BullModule } from '@nestjs/bullmq';

import { Campaign, Customer } from '@database/entities';
import { CampaignsService } from './campaigns.service';
import { CampaignsController } from './campaigns.controller';

/**
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 أنواع الحملات:
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * ┌─────────────────────────────────────────────────────────────────────────────┐
 * │                        CAMPAIGN TYPES                                       │
 * ├─────────────────────────────────────────────────────────────────────────────┤
 * │                                                                             │
 * │  1. 📅 SCHEDULED (مجدولة)                                                   │
 * │     - تُرسل في وقت محدد                                                     │
 * │     - مثال: حملة رمضان، العيد، الجمعة البيضاء                               │
 * │     - تُرسل لقائمة عملاء محددة (segment)                                    │
 * │                                                                             │
 * │  2. ⚡ TRIGGERED (مشروطة/تلقائية)                                            │
 * │     - تُرسل عند حدوث حدث معين                                               │
 * │     - مثال:                                                                │
 * │       • طلب جديد → رسالة شكر                                               │
 * │       • سلة متروكة → تذكير                                                 │
 * │       • شحن الطلب → إشعار التتبع                                           │
 * │       • بعد التوصيل → طلب تقييم                                            │
 * │                                                                             │
 * │  3. 🔄 RECURRING (متكررة)                                                   │
 * │     - تُرسل بشكل دوري                                                       │
 * │     - مثال: تذكير شهري، عرض أسبوعي                                          │
 * │                                                                             │
 * └─────────────────────────────────────────────────────────────────────────────┘
 */

@Module({
  imports: [
    // ═══════════════════════════════════════════════════════════════════════════════
    // 📁 Database
    // ═══════════════════════════════════════════════════════════════════════════════
    TypeOrmModule.forFeature([
      Campaign,       // الحملات
      Customer,        // للـ Segmentation
    ]),

    // ═══════════════════════════════════════════════════════════════════════════════
    // 📬 Queue لمعالجة الحملات
    // ═══════════════════════════════════════════════════════════════════════════════
    /**
     * لماذا Queue للحملات؟
     * 
     * حملة تسويقية قد تستهدف آلاف العملاء
     * لا نريد:
     * - إرسال كل الرسائل دفعة واحدة (rate limiting)
     * - الانتظار حتى تكتمل كل الإرسالات
     * 
     * الحل:
     * - نضيف كل رسالة كـ job منفصل
     * - الـ queue يرسلها بالتدريج
     * - نتتبع نجاح/فشل كل رسالة
     */
    BullModule.registerQueue({
      name: 'campaigns',
      defaultJobOptions: {
        attempts: 3,
        backoff: {
          type: 'exponential',
          delay: 5000, // 5 ثواني بين المحاولات
        },
        removeOnComplete: {
          age: 7 * 24 * 3600, // أسبوع
          count: 10000,
        },
        removeOnFail: {
          age: 30 * 24 * 3600, // شهر
        },
      },
    }),
  ],

  controllers: [CampaignsController],
  
  providers: [CampaignsService],

  exports: [CampaignsService],
})
export class CampaignsModule {}

/**
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 Flow حملة مجدولة:
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * ┌─────────────────────────────────────────────────────────────────────────────┐
 * │                    SCHEDULED CAMPAIGN FLOW                                  │
 * ├─────────────────────────────────────────────────────────────────────────────┤
 * │                                                                             │
 * │  1. إنشاء الحملة                                                            │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ POST /campaigns                              │                       │
 * │     │ {                                            │                       │
 * │     │   name: "حملة رمضان",                        │                       │
 * │     │   type: "scheduled",                         │                       │
 * │     │   scheduledAt: "2024-03-10T10:00:00Z",      │                       │
 * │     │   segment: { tags: ["vip"], minOrders: 3 }, │                       │
 * │     │   template: { ... }                         │                       │
 * │     │ }                                            │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  2. جدولة الحملة                                                            │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Campaign status: SCHEDULED                   │                       │
 * │     │ Cron job يراقب الحملات المجدولة             │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼ (عند الوقت المحدد)                               │
 * │  3. بدء التنفيذ                                                             │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Campaign status: RUNNING                     │                       │
 * │     │ - جلب العملاء المستهدفين (segment)          │                       │
 * │     │ - إنشاء job لكل عميل في الـ queue           │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  4. إرسال الرسائل                                                           │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Queue processor:                             │                       │
 * │     │ - معالجة رسالة واحدة                        │                       │
 * │     │ - تطبيق rate limiting                       │                       │
 * │     │ - تسجيل النتيجة (sent/failed)               │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  5. إكمال الحملة                                                           │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Campaign status: COMPLETED                   │                       │
 * │     │ Stats: { sent: 950, failed: 50, rate: 95% } │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                                                                             │
 * └─────────────────────────────────────────────────────────────────────────────┘
 * 
 * ═══════════════════════════════════════════════════════════════════════════════
 * 📌 Flow حملة مشروطة (Triggered):
 * ═══════════════════════════════════════════════════════════════════════════════
 * 
 * ┌─────────────────────────────────────────────────────────────────────────────┐
 * │                      TRIGGERED CAMPAIGN FLOW                                │
 * ├─────────────────────────────────────────────────────────────────────────────┤
 * │                                                                             │
 * │  1. إنشاء الحملة المشروطة                                                   │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ POST /campaigns                              │                       │
 * │     │ {                                            │                       │
 * │     │   name: "رسالة شكر بعد الطلب",               │                       │
 * │     │   type: "triggered",                         │                       │
 * │     │   trigger: "order.created",                  │                       │
 * │     │   delay: 0,  // إرسال فوري                   │                       │
 * │     │   template: { ... }                         │                       │
 * │     │ }                                            │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  2. الحملة تنتظر الحدث                                                      │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Campaign status: ACTIVE                      │                       │
 * │     │ Listening for: order.created events          │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼ (عند حدوث طلب جديد)                              │
 * │  3. استقبال الحدث                                                           │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Event: order.created                         │                       │
 * │     │ Payload: { orderId, customerId, ... }       │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  4. تطبيق الشروط (إذا وجدت)                                                 │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ Conditions check:                            │                       │
 * │     │ - orderTotal > 500? ✓                        │                       │
 * │     │ - customer.isNew? ✓                          │                       │
 * │     │ Result: SEND                                 │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                          │                                                  │
 * │                          ▼                                                  │
 * │  5. إرسال الرسالة                                                           │
 * │     ┌──────────────────────────────────────────────┐                       │
 * │     │ - تحضير الرسالة من القالب                   │                       │
 * │     │ - استبدال المتغيرات {{name}}, {{order_id}} │                       │
 * │     │ - إضافة للـ queue                           │                       │
 * │     │ - إرسال عبر القناة المناسبة                 │                       │
 * │     └──────────────────────────────────────────────┘                       │
 * │                                                                             │
 * └─────────────────────────────────────────────────────────────────────────────┘
 */

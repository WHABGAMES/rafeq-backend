/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘              RAFIQ PLATFORM - Permission Guard                                 â•‘
 * â•‘                                                                                â•‘
 * â•‘  ğŸ“Œ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù‚Ø¨Ù„ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„                                  â•‘
 * â•‘                                                                                â•‘
 * â•‘  ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†ÙÙŠØ°:                                                                 â•‘
 * â•‘  Request â†’ Middleware â†’ JwtAuthGuard â†’ PermissionGuard â†’ Controller            â•‘
 * â•‘                                              â†‘                                â•‘
 * â•‘                                          Ù†Ø­Ù† Ù‡Ù†Ø§!                              â•‘
 * â•‘                                                                                â•‘
 * â•‘  ÙƒÙŠÙ ÙŠØ¹Ù…Ù„:                                                                      â•‘
 * â•‘  1. ÙŠÙ‚Ø±Ø£ @RequirePermission('templates') Ù…Ù† Ø§Ù„Ù€ Controller/Method              â•‘
 * â•‘  2. ÙŠØ¬Ù„Ø¨ user.preferences.permissions Ù…Ù† Ø§Ù„Ù€ Request                           â•‘
 * â•‘  3. Owner â†’ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø³Ù…ÙˆØ­ (FULL_PERMISSIONS)                                    â•‘
 * â•‘  4. ØºÙŠØ±Ù‡ â†’ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©                                          â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
  Logger,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';

/**
 * ğŸ“Œ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ Metadata Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
 */
export const PERMISSION_KEY = 'required_permission';

/**
 * ğŸ“Œ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
 * ÙŠØ¬Ø¨ Ø£Ù† ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ StaffPermissions interface ÙÙŠ users.service.ts
 */
export type PermissionType =
  | 'conversations'
  | 'contacts'
  | 'templates'
  | 'campaigns'
  | 'analytics'
  | 'settings'
  | 'quickReplies'
  | 'ai';

@Injectable()
export class PermissionGuard implements CanActivate {
  private readonly logger = new Logger(PermissionGuard.name);

  constructor(private readonly reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù€ Decorator
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const requiredPermission = this.reflector.getAllAndOverride<PermissionType>(
      PERMISSION_KEY,
      [
        context.getHandler(),  // ÙØ­Øµ Ø§Ù„Ù€ method Ø£ÙˆÙ„Ø§Ù‹
        context.getClass(),    // Ø«Ù… Ø§Ù„Ù€ class
      ],
    );

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ© â†’ Ù…Ø³Ù…ÙˆØ­ (backwards compatible)
    if (!requiredPermission) {
      return true;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù€ Request
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3. Owner â†’ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø³Ù…ÙˆØ­
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    if (user.role === 'owner') {
      return true;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. Manager â†’ Ù…Ø³Ù…ÙˆØ­ Ù„ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Manager ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ÙƒÙ„ Ø´ÙŠØ¡ â€” Ù„ÙƒÙ† ÙŠØ®Ø¶Ø¹ Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø°Ø§ Ø£Ø±Ø§Ø¯ Ø§Ù„Ù€ Owner ØªÙ‚ÙŠÙŠØ¯Ù‡
    // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø¹ÙØ§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…Ù† ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙØ¹Ù‘Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ:
    // if (user.role === 'manager') return true;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5. ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const permissions = user.preferences?.permissions;

    if (!permissions) {
      this.logger.warn(
        `Access denied: User ${user.id} has no permissions defined (required: ${requiredPermission})`,
      );
      throw new ForbiddenException('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
    }

    if (permissions[requiredPermission] !== true) {
      this.logger.warn(
        `Access denied: User ${user.id} lacks '${requiredPermission}' permission`,
      );
      throw new ForbiddenException(
        `Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‚Ø³Ù… ${this.getPermissionLabel(requiredPermission)}`,
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… Ù…Ø³Ù…ÙˆØ­
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    return true;
  }

  /**
   * ØªØ³Ù…ÙŠØ§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£)
   */
  private getPermissionLabel(permission: PermissionType): string {
    const labels: Record<PermissionType, string> = {
      conversations: 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª',
      contacts: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
      templates: 'Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨',
      campaigns: 'Ø§Ù„Ø­Ù…Ù„Ø§Øª',
      analytics: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª',
      settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
      quickReplies: 'Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©',
      ai: 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
    };
    return labels[permission] || permission;
  }
}
